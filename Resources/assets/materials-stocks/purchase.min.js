executeFunc(function materialStocsPurchase(){ChangePurchaseForm=document.forms.purchase_material_stock_form;if(typeof ChangePurchaseForm==="undefined"){return false}var object_category=document.getElementById(ChangePurchaseForm.name+"_category");if(object_category===null){return false}object_category.addEventListener("change",function(){changeObjectCategory(ChangePurchaseForm)},false);let numberElement=document.getElementById(ChangePurchaseForm.name+"_invariable_number");numberElement.focus();numberElement.addEventListener("keydown",function(event){if(event.key==="Enter"){event.preventDefault();var categoryElementSelect2=document.getElementById(ChangePurchaseForm.name+"_category_select2");if(categoryElementSelect2){categoryElementSelect2.click()}else{var categoryElementSelect=document.getElementById(ChangePurchaseForm.name+"_category");categoryElementSelect2.click()}}});let $addButtonStock=document.getElementById(ChangePurchaseForm.name+"_addPurchase");$addButtonStock.addEventListener("click",addMaterialPurchase,false);document.getElementById(ChangePurchaseForm.name+"_purchase").addEventListener("click",function(event){if(ChangePurchaseForm.querySelectorAll(".item-collection-material")?.length<=0){let $errorFormHandlerMaterials=JSON.stringify({type:"danger",header:"Добавить лист закупки сырья",message:"В списке нет ни одного элемента сырья"});createToast(JSON.parse($errorFormHandlerMaterials));return false}let elementTotal=document.getElementById(ChangePurchaseForm.name+"_preTotal");if(elementTotal){if(elementTotal.value.trim()!==""){let $errorFormHandlerMaterials=JSON.stringify({type:"danger",header:"Добавить лист закупки сырья",message:'Вы не добавили сырьё в общий список кликнув "+ Добавить в закупку"'});createToast(JSON.parse($errorFormHandlerMaterials));return false}}if(event.key!=="Enter"){submitModalForm(ChangePurchaseForm)}return false});return true});async function changeObjectCategory(forms){disabledElementsForm(forms);document.getElementById("preMaterial")?.classList.add("d-none");document.getElementById("preOffer")?.classList.add("d-none");document.getElementById("preVariation")?.classList.add("d-none");document.getElementById("preModification")?.classList.add("d-none");document.getElementById("purchase_material_stock_form_addPurchase")?.classList.replace("btn-outline-primary","btn-outline-secondary");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preMaterial=result.getElementById("preMaterial");if(preMaterial){preMaterial.querySelectorAll(".is-invalid").forEach(el=>{el.classList.remove("is-invalid")});preMaterial.querySelectorAll(".invalid-feedback").forEach(el=>{el.remove()})}document.getElementById("preMaterial").replaceWith(preMaterial);preMaterial?document?.getElementById("material")?.replaceWith(preMaterial):preMaterial.innerHTML="";let replacer=document.getElementById(forms.name+"_preMaterial");replacer&&replacer.type!=="hidden"?preMaterial.classList.remove("d-none"):null;if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preMaterial_select2");focus?focus.click():null}}let preOffer=document.getElementById("preOffer");preOffer?preOffer.innerHTML="":null;let preVariation=document.getElementById("preVariation");preVariation?preVariation.innerHTML="":null;let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null;if(replacer){replacer.addEventListener("change",function(event){changeObjectMaterial(forms);return false})}}enableElementsForm(forms)})}async function changeObjectMaterial(forms){disabledElementsForm(forms);document.getElementById("preOffer")?.classList.add("d-none");document.getElementById("preVariation")?.classList.add("d-none");document.getElementById("preModification")?.classList.add("d-none");document.getElementById("purchase_material_stock_form_addPurchase")?.classList.replace("btn-outline-primary","btn-outline-secondary");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preOffer=result.getElementById("preOffer");preOffer?document.getElementById("preOffer").replaceWith(preOffer):preOffer.innerHTML="";if(preOffer){preOffer.querySelectorAll(".is-invalid").forEach(el=>{el.classList.remove("is-invalid")});preOffer.querySelectorAll(".invalid-feedback").forEach(el=>{el.remove()});let replaceOfferId=forms.name+"_preOffer";let replacer=document.getElementById(replaceOfferId);replacer&&replacer.type!=="hidden"?preOffer.classList.remove("d-none"):null;if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preOffer_select2");focus?focus.click():null}else{selectTotal(forms)}}let preVariation=document.getElementById("preVariation");preVariation?preVariation.innerHTML="":null;let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null;let offerChange=document.getElementById(forms.name+"_preOffer");if(offerChange){offerChange.addEventListener("change",function(event){changeObjectOffer(forms);return false})}}enableElementsForm(forms)})}async function changeObjectOffer(forms){disabledElementsForm(forms);document.getElementById("preVariation")?.classList.add("d-none");document.getElementById("preModification")?.classList.add("d-none");document.getElementById("purchase_material_stock_form_addPurchase")?.classList.replace("btn-outline-primary","btn-outline-secondary");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preVariation=result.getElementById("preVariation");if(preVariation){preVariation.querySelectorAll(".is-invalid").forEach(el=>{el.classList.remove("is-invalid")});preVariation.querySelectorAll(".invalid-feedback").forEach(el=>{el.remove()});document.getElementById("preVariation").replaceWith(preVariation);let replacer=document.getElementById(forms.name+"_preVariation");replacer&&replacer.type!=="hidden"?preVariation.classList.remove("d-none"):null;if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preVariation_select2");focus?focus.click():null;replacer.addEventListener("change",function(event){changeObjectVariation(forms);return false})}else{selectTotal(forms)}}}let preModification=document.getElementById("preModification");preModification?preModification.innerHTML="":null}enableElementsForm(forms)})}async function changeObjectVariation(forms){disabledElementsForm(forms);document.getElementById("preModification")?.classList.add("d-none");document.getElementById("purchase_material_stock_form_addPurchase")?.classList.replace("btn-outline-primary","btn-outline-secondary");const data=new FormData(forms);data.delete(forms.name+"[_token]");await fetch(forms.action,{method:forms.method,cache:"no-cache",credentials:"same-origin",headers:{"X-Requested-With":"XMLHttpRequest"},redirect:"follow",referrerPolicy:"no-referrer",body:data}).then(response=>{if(response.status!==200){return false}return response.text()}).then(data=>{if(data){var parser=new DOMParser;var result=parser.parseFromString(data,"text/html");let preModification=result.getElementById("preModification");if(preModification){preModification.querySelectorAll(".is-invalid").forEach(el=>{el.classList.remove("is-invalid")});preModification.querySelectorAll(".invalid-feedback").forEach(el=>{el.remove()});document.getElementById("preModification").replaceWith(preModification);let replacer=document.getElementById(forms.name+"_preModification");replacer&&replacer.type!=="hidden"?preModification.classList.remove("d-none"):null;if(replacer){if(replacer.tagName==="SELECT"){new NiceSelect(replacer,{searchable:true});let focus=document.getElementById(forms.name+"_preModification_select2");focus?focus.click():null;replacer.addEventListener("change",function(event){selectTotal(forms);return false})}else{selectTotal(forms)}}}}enableElementsForm(forms)})}function selectTotal(forms){setTimeout(function(){let focusTotal=document.getElementById(ChangePurchaseForm.name+"_preTotal");document.getElementById(ChangePurchaseForm.name+"_addPurchase")?.classList.replace("btn-outline-secondary","btn-outline-primary");focusTotal.value="";focusTotal?focusTotal.focus():null;focusTotal.addEventListener("keydown",enterTotalElement)},100)}function enterTotalElement(event){if(event.key==="Enter"){event.preventDefault();addMaterialPurchase();document.removeEventListener("keydown",enterTotalElement)}}var collectionMaterialPurshase=new Map;function addMaterialPurchase(){const dynamicElements=["preMaterial","preOffer","preVariation","preModification"];let $blockCollectionStock=document.getElementById("collectionStock");let $errorFormHandler=null;let header="Добавить лист закупки сырья";let $preTotal=document.getElementById(ChangePurchaseForm.name+"_preTotal");let $TOTAL=$preTotal.value*1;if($TOTAL===undefined||$TOTAL<1){$errorFormHandler=JSON.stringify({type:"danger",header:header,message:"Не заполнено количество"})}let $number=document.getElementById(ChangePurchaseForm.name+"_invariable_number");if($number===null||$number.value.length===0){$errorFormHandler=JSON.stringify({type:"danger",header:header,message:"Не заполнен номер закупки"})}let $preCategory=document.getElementById(ChangePurchaseForm.name+"_category");let $preMaterial=document.getElementById(ChangePurchaseForm.name+"_preMaterial");let $preOffer=document.getElementById(ChangePurchaseForm.name+"_preOffer");let $preVariation=document.getElementById(ChangePurchaseForm.name+"_preVariation");let $preModification=document.getElementById(ChangePurchaseForm.name+"_preModification");if($preCategory.value.length===0){$errorFormHandler=JSON.stringify({type:"danger",header:header,message:$preCategory.options[0].textContent})}dynamicElements.forEach(id=>{const element=document.getElementById(ChangePurchaseForm.name+"_"+id);if(element&&element.tagName==="SELECT"&&element.value.length===0){const message=element.options[0].textContent;$errorFormHandler=JSON.stringify({type:"danger",header:header,message:message})}});const mapKey=[$preMaterial,$preOffer,$preVariation,$preModification].map(item=>item?item.value:"").join("");if(collectionMaterialPurshase.has(mapKey)){$errorFormHandler=JSON.stringify({type:"danger",header:header,message:"сырьё уже добавлено в список"})}if($errorFormHandler){createToast(JSON.parse($errorFormHandler));return false}let $addButtonStock=document.getElementById(ChangePurchaseForm.name+"_addPurchase");let newForm=$addButtonStock.dataset.prototype;let index=$addButtonStock.dataset.index*1;newForm=newForm.replace(/__material__/g,index);let stockDiv=document.createElement("div");stockDiv.classList.add("item-collection-material");stockDiv.classList.add("w-100");stockDiv.innerHTML=newForm;$blockCollectionStock.append(stockDiv);let $total=stockDiv.querySelector("#"+ChangePurchaseForm.name+"_material_"+index+"_total");$total.value=$preTotal.value;let $material=stockDiv.querySelector("#"+ChangePurchaseForm.name+"_material_"+index+"_material");$material.value=$preMaterial.value;let materialIndex=$preMaterial.selectedIndex;let $materialName=$preMaterial.options[materialIndex].textContent;let $offerName="";if($preOffer){let $offer=stockDiv.querySelector("#"+ChangePurchaseForm.name+"_material_"+index+"_offer");$offer.value=$preOffer?.value;let offerIndex=$preOffer.selectedIndex;$offerName=$preOffer.tagName==="SELECT"?'&nbsp; <small class="text-muted fw-normal">'+document.querySelector('label[for="'+$preOffer.id+'"]').textContent+"</small> "+$preOffer.options[offerIndex].textContent:""}let $variationName="";if($preVariation){let $variation=stockDiv.querySelector("#"+ChangePurchaseForm.name+"_material_"+index+"_variation");$variation.value=$preVariation.value;let variationIndex=$preVariation.selectedIndex;$variationName=$preVariation.tagName==="SELECT"?'&nbsp; <small class="text-muted fw-normal">'+document.querySelector('label[for="'+$preVariation.id+'"]').textContent+"</small> "+$preVariation.options[variationIndex].textContent:""}let $modificationName="";if($preModification){let $modification=stockDiv.querySelector("#"+ChangePurchaseForm.name+"_material_"+index+"_modification");$modification.value=$preModification.value;let modificationIndex=$preModification.selectedIndex;$modificationName=$preModification.tagName==="SELECT"?'&nbsp; <small class="text-muted fw-normal">'+document.querySelector('label[for="'+$preModification.id+'"]').textContent+"</small> "+$preModification.options[modificationIndex].textContent:""}let $materialTextBlock=stockDiv.querySelector("#material-text-"+index);$materialTextBlock.innerHTML=$materialName+$offerName+$variationName+$modificationName+"&nbsp; : &nbsp;"+$total.value+" шт.";$preTotal.value=null;stockDiv.querySelector(".del-item-material").addEventListener("click",function(){this.closest(".item-collection-material").remove();index=$addButtonStock.dataset.index*1;$addButtonStock.dataset.index=(index-1).toString();collectionMaterialPurshase.delete(mapKey)});$addButtonStock.dataset.index=(index+1).toString();dynamicElements.forEach(id=>{if(id==="preMaterial"){return}const element=document.getElementById(id);if(element){element.innerHTML="";element.classList.add("d-none")}});collectionMaterialPurshase.set(mapKey,$total.value);var limit_faaJUfW=1e3;setTimeout(function init_TQCmNQtx(){var input_preMaterial_select=document.getElementById(ChangePurchaseForm.name+"_preMaterial_select2");if(input_preMaterial_select){input_preMaterial_select.click();return}var input_preMaterial=document.getElementById(ChangePurchaseForm.name+"_preMaterial");if(input_preMaterial){document.getElementById(ChangePurchaseForm.name+"_preMaterial_select2");return}if(limit_faaJUfW>1e3){return}limit_faaJUfW=limit_faaJUfW*2;setTimeout(init_TQCmNQtx,limit_faaJUfW)},100)}